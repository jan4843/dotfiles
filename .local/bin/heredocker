#!/bin/sh -e

expand() {
	if ! [ -d "$1" ]; then
		dir=$(cd -- "$(dirname "$1")" && pwd)
		printf '%s/%s\n' "$dir" "$(basename "$1")"
	else
		(cd -- "$1" && pwd)
	fi
}

for arg in "$@"; do
	if [ -z "$reset_args" ]; then
		set --
		reset_args=1
	fi

	case "$arg" in
		[0-9]*:[0-9]*)
			set -- --publish="$arg" "$@"
			;;
		[0-9]*/*)
			port=${arg%/*}
			proto=${arg#*/}
			set -- --publish="$port:$port/$proto" "$@"
			;;
		[0-9]*)
			set -- --publish="$arg:$arg" "$@"
			;;
		.:*|..:*|./:*|./*:*|../:*|../*:*|/*:*)
			src=$(expand "${arg%%:*}")
			dst=${arg#*:}
			set -- --volume="$src:$dst" "$@"
			;;
		.|..|./*|../*|/*)
			workdir=$(expand "$arg")
			set -- --volume="$workdir:/host" --workdir="/host" "$@"
			;;
		$)
			cmd='command -v bash > /dev/null && exec bash "$@" || exec sh "$@"'
			set -- --entrypoint=sh "$@" -c "$cmd"
			;;
		*)
			set -- "$@" "$arg"
			;;
	esac
done

if [ -t 0 ]; then
	set -- --tty "$@"
fi

if grep -q desktop ~/.docker/config.json 2>/dev/null; then
	set -- \
		--volume ~/.ssh:/root/.ssh:ro \
		--volume "$(realpath ~/.ssh/config)":/root/.ssh/config:ro \
		--volume /run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock:ro \
		--env SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock \
		"$@"
fi

set -- docker container run --rm --init --interactive "$@"
exec "$@"
